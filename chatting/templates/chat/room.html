<!-- chat/templates/chat/room.html -->
{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
<head>

  <!-- SITE TITTLE -->
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>聊天</title>

  <!-- FAVICON -->
  <link href="{% static 'images/favicon.png' %}" rel="shortcut icon">
  <!-- PLUGINS CSS STYLE -->
  <!-- <link href="plugins/jquery-ui/jquery-ui.min.css" rel="stylesheet"> -->
  <link rel="stylesheet" href="{% static 'plugins/bootstrap/css/bootstrap.min.css' %} ">
  <link rel="stylesheet" href="{% static 'plugins/bootstrap/css/bootstrap-slider.css' %}">
  <!-- Font Awesome -->
  <link href="{% static 'plugins/font-awesome/css/font-awesome.min.css' %}" rel="stylesheet">
  <!-- Owl Carousel -->
  <link href="{% static 'plugins/slick-carousel/slick/slick.css' %}" rel="stylesheet">
  <link href="{% static 'plugins/slick-carousel/slick/slick-theme.css' %}" rel="stylesheet">
  <!-- Fancy Box -->
  <link href="{% static 'plugins/fancybox/jquery.fancybox.pack.css' %}" rel="stylesheet">
  <link href="{% static 'plugins/jquery-nice-select/css/nice-select.css' %}" rel="stylesheet">
  <!-- CUSTOM CSS -->
  <link href="{% static 'css/style.css' %}" rel="stylesheet">
  <link href="{% static 'css/chat.css' %}" rel="stylesheet">


  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->

</head>
<body>
{#    <textarea id="chat-log" cols="100" rows="20"></textarea><br/>#}
{#    <input id="chat-message-input" type="text" size="100"/><br/>#}
{#    <input id="chat-message-submit" type="button" value="Send"/>#}
<section>
<div class="container">
    <div class="row">
        <div class="col-lg-12">
            <div class="widget-box widget-chat">
                <div class="widget-title">
                    <span><i class="fa fa-comment"></i> &nbsp;&nbsp;Chat</span>
                </div>
                <div class="widget-content">
                    <div class="chat-content panel-left">
                        <div class="chat-messages" id="chat-messages">
                            <div id="chat-messages-inner">
                            </div>
                        </div>
                        <div class="chat-message well">
                            <span class="input-box">
                                <textarea  class="rounded form-control bg-white" name="msg-box" id="msg-box" autocapitalize="on" style="width: 117%; height: 150px;margin-left: -10px;"></textarea>
                            </span><br>
                            <button class="btn btn-success">点击发送</button>
                        </div>
                    </div>
                    <div class="chat-users panel-right">
                        <div class="panel-title"><h5>对方信息</h5></div>
                        <div class="panel-content nopadding">
                            <ul class="contact-list">
                                <li>
                                    <a href=""><img src="{{ recv_side_user.header_image.url }}" alt="" style="border-radius: 50px; width: 20%"><span>&nbsp;&nbsp;&nbsp;{{ recv_side_user.username }}</span></a>
                                </li>
                                <li><span>电话：{{ recv_side_user.telephone }}</span></li>
                                <li><span>邮箱📮：{{ recv_side_user.email }}</span></li>
                                <li><span>个人介绍：{{ recv_side_user.introduction }}</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</section>
<footer class="footer section section-sm">
  <!-- Container Start -->
  <div class="container">
    <div class="row">
      <div class="col-lg-3 col-md-7 offset-md-1 offset-lg-0">
        <!-- About -->
        <div class="block about">
          <!-- footer logo -->
          <!-- description -->
          <p class="alt-color">友情相关链接🔗</p>
        </div>
      </div>
      <!-- Link list -->
      <div class="col-lg-4 offset-lg-1 col-md-4">
        <div class="block">
          <ul>
            <li><a href="https://github.com" target="_blank"><i class="fa fa-github"></i> Github</a></li>
            <li><a href="http://www.kongfz.com/" target="_blank"><i class="fa fa-language"></i> 孔夫子旧书网</a></li>
            <li><a href="https://www.jiushujie.com/home" target="_blank"><i class="fa fa-bank"></i> 旧书街</a></li>
          </ul>
        </div>
      </div>
      <!-- Link list -->
      <div class="col-lg-2 col-md-3 offset-md-1 offset-lg-0">
        <div class="block">
          <ul>
            <li><a href="http://www.dangdang.com/" target="_blank"><i class="fa fa-male"></i> 当当网</a></li>
            <li><a href="https://www.jd.com/" target="_blank"><i class="fa fa-bed"></i> 京东</a></li>
            <li><a href="https://www.amazon.cn/" target="_blank"><i class="fa fa-beer"></i> 亚马逊</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  <!-- Container End -->
</footer>
<footer class="footer-bottom">
  <!-- Container Start -->
  <div class="container">
    <div class="row">
      <div class="col-sm-6 col-12">
        <!-- Copyright -->
        <div class="copyright">
          <p>Old Books Trade Website for BS course.</p><br>
          <p>Copyright © <script>
              var CurrentYear = new Date().getFullYear();
              document.write(CurrentYear)
            </script>. All Rights Reserved by <strong>Huangyifei</strong>, <br>See my github <a class="text-primary" href="https://github.com/MySuperSoul" target="_blank">Rothyu.</a></p>
        </div>
      </div>
      <div class="col-sm-6 col-12">
        <!-- Social Icons -->
        <ul class="social-media-icons text-right">
          <li><a class="fa fa-github" href="https://github.com/MySuperSoul" target="_blank"></a></li>
          <li><a class="fa fa-wikipedia-w" href="https://mysupersoul.github.io" target="_blank"></a></li>
          <li><a class="fa fa-envelope" href="mailto:huangyifei0910@gmail.com" target="_blank"></a></li>
        </ul>
      </div>
    </div>
  </div>
  <!-- Container End -->
  <!-- To Top -->
  <div class="top-to">
    <a id="top" class="" href="#"><i class="fa fa-angle-up"></i></a>
  </div>
</footer>

<!-- JAVASCRIPTS -->
<script src="{% static 'plugins/jQuery/jquery.min.js' %}"></script>
<script src="{% static 'plugins/bootstrap/js/popper.min.js' %}"></script>
<script src="{% static 'plugins/bootstrap/js/bootstrap.min.js' %}"></script>
<script src="{% static 'plugins/bootstrap/js/bootstrap-slider.js' %}"></script>
  <!-- tether js -->
<script src="{% static 'plugins/tether/js/tether.min.js' %}"></script>
<script src="{% static 'plugins/raty/jquery.raty-fa.js' %}"></script>
<script src="{% static 'plugins/slick-carousel/slick/slick.min.js' %}"></script>
<script src="{% static 'plugins/jquery-nice-select/js/jquery.nice-select.min.js' %}"></script>
<script src="{% static 'plugins/fancybox/jquery.fancybox.pack.js' %}"></script>
<script src="{% static 'plugins/smoothscroll/SmoothScroll.min.js' %}"></script>
<!-- google map -->
{#<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCcABaamniA6OL5YvYSpB3pFMNrXwXnLwU&libraries=places"></script>#}
<script src="{% static 'plugins/google-map/gmap.js' %}"></script>
<script src="{% static 'js/script.js' %}"></script>
<script src="{% static 'js/js.cookie-2.2.0.min.js' %}"></script>
</body>
<script type="text/javascript">

Date.prototype.format = function(fmt) {
     var o = {
        "M+" : this.getMonth()+1,                 //月份
        "d+" : this.getDate(),                    //日
        "h+" : this.getHours(),                   //小时
        "m+" : this.getMinutes(),                 //分
        "s+" : this.getSeconds(),                 //秒
        "q+" : Math.floor((this.getMonth()+3)/3), //季度
        "S"  : this.getMilliseconds()             //毫秒
    };
    if(/(y+)/.test(fmt)) {
            fmt=fmt.replace(RegExp.$1, (this.getFullYear()+"").substr(4 - RegExp.$1.length));
    }
     for(var k in o) {
        if(new RegExp("("+ k +")").test(fmt)){
             fmt = fmt.replace(RegExp.$1, (RegExp.$1.length===1) ? (o[k]) : (("00"+ o[k]).substr((""+ o[k]).length)));
         }
     }
    return fmt;
};
</script>
<script>
    $(document).ready(function(){
	var send_side = {{ send_side }};
    var recv_side = {{ recv_side }};
    var room_number = '';

    if(Number(send_side) < Number(recv_side)) room_number = send_side + "_" + recv_side + "_1";
    else room_number = recv_side + "_" + send_side + "_2";

    var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + room_number.toString() + '/');

    chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var message = data['message'];
        var message_send_side = Number(data['send_side']);
        $.ajax({
            type: "post",
            url: "/chatting/api/search_user_info/" + message_send_side.toString() + "/",
            dataType: "json",
            success : function (data) {
                console.log(data);
                var image_url = data.data.image_url;
                var username = data.data.username;
                add_message(username.toString(), image_url.toString(), message.toString(), true, '');
            }
        })
     };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
     };

	$('.chat-message button').click(function(){
		var input = $(this).siblings('span').children('input[type=text]').val();
		if(input !== ''){
			add_message('我',"{{ send_side_user.header_image.url }}",input.val(),true, '');
			var message = {
			    send_side : send_side,
                recv_side : recv_side,
                message : input
            };
            chatSocket.send(JSON.stringify(message));
		}
	});

	$('.chat-message textarea').keypress(function(e){
		if(e.which === 13) {
			if($(this).val() !== ''){
			    var message = {
			        send_side : send_side,
                    recv_side : recv_side,
                    message : $(this).val()
                };
				add_message('我',"{{ send_side_user.header_image.url }}",$(this).val(),true,'');
                chatSocket.send(JSON.stringify(message));
			}
		}
	});

   	var i = 0;
	function add_message(name,img,msg,clear,message_time) {
		i = i + 1;
		var time = null;
		var  inner = $('#chat-messages-inner');
		var flag = true;
		var slide_time = 100;
		if(message_time === ''){
		    time = new Date();
            time = time.format("yyyy-MM-dd hh:mm:ss");
            flag = false;
            slide_time = 1000;
        }else {
		    time = message_time;
        }

		var id = 'msg-'+i;
        var idname = name.replace(' ','-').toLowerCase();
		inner.append('<p id="'+id+'" class="user-'+idname+'"><img src="'+img+'" alt="" />'
										+'<span class="msg-block"><strong>'+name+'</strong> <span class="time">- '+time+'</span>'
										+'<span class="msg">'+msg+'</span></span></p>');
		if(flag === true) $('#'+id).hide().fadeIn(800);
		if(clear) {
			$('.chat-message textarea').val('').focus();
		}
		$('#chat-messages').animate({ scrollTop: inner.height() },slide_time);
	}

    {% for message in messages %}
    {% if message.send_side_id == send_side %}
        add_message('我', "{{ message.send_side.header_image.url }}", "{{ message.message }}", true, "{{ message.create_time|date:'Y-m-d H:i:s' }}");
        {% else %}
        add_message('{{ message.send_side.username }}', "{{ message.send_side.header_image.url }}", "{{ message.message }}", true, "{{ message.create_time|date:'Y-m-d H:i:s' }}");
    {% endif %}
    {% endfor %}
    $('#chat-messages').animate({ scrollTop: inner.height() },1000);
});


</script>
</html>